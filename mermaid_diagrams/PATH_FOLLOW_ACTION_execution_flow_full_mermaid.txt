graph TD
    A["ğŸ® User Presses '5' Key<br/>(PATH_FOLLOW_ACTION)"] --> B["ğŸ¯ QuestManager.filter_action()"]
    
    B --> B1{{"ğŸ” Dialog Active?"}}
    B1 -->|Yes| B2["âœ‹ Return Original Action<br/>(Player controls dialog)"]
    B1 -->|No| B3["ğŸ”„ Call get_current_quest()"]
    
    B3 --> B4["ğŸ“‹ QuestProgressionEngine<br/>determines active quest"]
    B4 --> B5["ğŸ—ï¸ StageManager.scripted_stage_blocking()"]
    
    B5 --> C1{{"ğŸš« Warp Blocked?"}}
    C1 -->|Yes| C2["ğŸ”„ Return alternate action<br/>(e.g., NOOP)"]
    C1 -->|No| C3["ğŸ¬ StageManager.scripted_stage_movement()"]
    
    C3 --> D1{{"ğŸ“ Match scripted conditions?"}}
    D1 -->|Yes| D2["ğŸ¯ Return scripted action<br/>(overrides PATH_FOLLOW)"]
    D1 -->|No| D3["ğŸ—ºï¸ _convert_path_follow_to_movement()"]
    
    D3 --> E1["ğŸ“ Get current player position<br/>local_to_global(y, x, map_id)"]
    E1 --> E2["ğŸ§­ Check Navigator state<br/>navigator.current_coordinate_index"]
    
    E2 --> F1{{"ğŸ“Š Navigator has coordinates?"}}
    F1 -->|No| F2["ğŸ” _ensure_quest_loaded()<br/>Load quest coordinate path"]
    F2 --> F3{{"âœ… Quest loaded successfully?"}}
    F3 -->|No| F4["âš ï¸ Return original action<br/>(fallback)"]
    F3 -->|Yes| F1
    
    F1 -->|Yes| G1["ğŸ¯ Get target coordinate<br/>navigator.sequential_coordinates[index]"]
    
    G1 --> H1{{"ğŸ“ Already at target?"}}
    H1 -->|Yes| H2["â¬†ï¸ Advance Navigator index<br/>navigator.current_coordinate_index += 1"]
    H2 --> H3{{"ğŸ End of path?"}}
    H3 -->|Yes| H4["âœ… Return original action<br/>(quest complete)"]
    H3 -->|No| G1
    
    H1 -->|No| I1{{"ğŸ—ºï¸ Target on current map?"}}
    I1 -->|No| I2["ğŸšª WARP LOGIC<br/>Find nearest warp door"]
    I2 --> I3["ğŸ“ Calculate movement to warp<br/>prioritize larger delta"]
    I3 --> I4["â†©ï¸ Return warp movement<br/>(UP/DOWN/LEFT/RIGHT)"]
    
    I1 -->|Yes| J1["ğŸ“ Calculate movement vector<br/>dy = target_y - current_y<br/>dx = target_x - current_x"]
    J1 --> J2["ğŸ¯ Select movement direction<br/>prioritize larger absolute delta"]
    J2 --> J3["â†©ï¸ Return movement action<br/>(0=DOWN, 1=LEFT, 2=RIGHT, 3=UP)"]
    
    C2 --> K1["ğŸ® Environment.step(action)"]
    D2 --> K1
    F4 --> K1
    H4 --> K1
    I4 --> K1
    J3 --> K1
    
    K1 --> L1["ğŸ² Environment.run_action_on_emulator()"]
    L1 --> L2["ğŸ“± PyBoy executes button press"]
    L2 --> L3["ğŸ® Game state updates"]
    
    L3 --> M1{{"ğŸšª Warp occurred?"}}
    M1 -->|Yes| M2["ğŸ—ºï¸ Navigator.warp_tile_handler()"]
    M2 --> M3["ğŸ“ Update coordinate index<br/>for destination map"]
    M3 --> M4["ğŸ¯ Snap to nearest coordinate<br/>on new map"]
    
    M1 -->|No| N1{{"âœ… Movement successful?"}}
    N1 -->|Yes| N2["ğŸ“ Position updated<br/>continue path following"]
    N1 -->|No| N3["âš ï¸ Movement failed<br/>collision or blocked"]
    
    N2 --> O1["ğŸ”„ Next step() call"]
    N3 --> O1
    M4 --> O1
    
    O1 --> A
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style D3 fill:#fff3e0
    style G1 fill:#e8f5e8
    style I2 fill:#ffebee
    style J2 fill:#f1f8e9
    style K1 fill:#fce4ec
    style L2 fill:#e3f2fd